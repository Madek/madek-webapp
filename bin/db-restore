#!/usr/bin/env bash

set -eux

PROJECT_DIR="$(cd -- "$(dirname "${BASH_SOURCE}")" ; cd .. > /dev/null 2>&1 && pwd -P)"
cd $PROJECT_DIR

FILE=${FILE:-tmp/latest.pgbin}
RAILS_ENV=development
bundle exec rake db:create || true
bundle exec rake db:environment:set
source $PROJECT_DIR/bin/pg_env
# echo "ENTER to continue; abort with CTRL-C"
# read
psql -c "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '$PGDATABASE' AND pid <> pg_backend_pid();"
psql -c "DROP DATABASE IF EXISTS $PGDATABASE"
psql -c "CREATE DATABASE $PGDATABASE"
# this is required to restore dumps from PG <= 10 into PG >= 11
# { pg_restore --version | grep -q -E '(11\.|12\.|13\.|14|.)' ;} && psql -d $PGDATABASE -c "DROP SCHEMA IF EXISTS \"public\";"
pg_restore --disable-triggers -j $J -x -O -d $PGDATABASE $FILE
bundle exec rake db:migrate
