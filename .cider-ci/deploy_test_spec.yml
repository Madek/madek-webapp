name: Deploy Madek V3 to Test

task_defaults:

  traits:
    deploy-madek-test: true
    linux: true

  exclusive_resources:
    "test.madek.zhdk.ch": true

  git_options:
    submodules:
      clone: true
      timeout: 30

tasks:
  deploy:
    name: Deploy
    auto_trials: 1

    scripts:
      deploy:
        body: REF=$(git log -n 1 --pretty='%H') && cd deploy/ansible && ansible-playbook -i hosts_zhdk-test play_setup-and-deploy.yml -e madek_git_ref=$REF
        timeout: 10000
