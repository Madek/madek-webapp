configure-database:
  body: |
    #!/usr/bin/ruby
    require 'yaml'
    db_config = {
      'adapter' => 'postgresql',
      'encoding' => 'unicode',
      'host' => 'localhost',
      'pool' => 10,
      'username' => ENV['PGUSER'],
      'password' =>  ENV['PGPASSWORD'],
      'database' => ENV['DATABASE_NAME']}
    config = { 'test' => db_config, 'production' => db_config}
    File.open('config/database.yml','w') { |file| file.write config.to_yaml }

create-database:
  body: |
    #!/usr/bin/env bash
    set -eux
    cd datalayer
    createdb "${DATABASE_NAME}"
    psql -d "${DATABASE_NAME}" -f db/structure.sql
  start-when:
  - script: configure-database


delete-database:
  body: |
    set -eux
    cd webapp
    dropdb "${DATABASE_NAME}"
  ignore-state: true
  ignore-abort: true
  start-when:
  - script: test
    states: [aborted, passed, failed, skipped]
