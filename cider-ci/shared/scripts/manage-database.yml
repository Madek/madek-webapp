configure-database:
  body: |
    #!/usr/bin/ruby
    require 'yaml'
    db_config = {
      'adapter' => 'postgresql',
      'encoding' => 'unicode',
      'host' => 'localhost',
      'pool' => 10,
      'username' => ENV['PGUSER'],
      'password' =>  ENV['PGPASSWORD'],
      'database' => "madek_v3_test_#{ENV['CIDER_CI_TRIAL_ID']}"}
    config = { 'test' => db_config, 'production' => db_config}
    File.open('config/database.yml','w') { |file| file.write config.to_yaml }

create-database:
  body: |
    #!/usr/bin/env bash
    set -eux
    export PATH=$(pwd)/vendor/jruby/bin/:$(ruby -e "puts ENV['PATH'].split(':').reject{|s| s.match(/\.rbenv/)}.join(':')")
    jruby --dev -S bundle exec rake db:reset
  start-when:
  - script: configure-database

delete-database:
  body:
    #!/usr/bin/env bash
    set -eux
    export PATH=$(pwd)/vendor/jruby/bin/:$(ruby -e "puts ENV['PATH'].split(':').reject{|s| s.match(/\.rbenv/)}.join(':')")
    jruby --dev -S bundle exec rake db:drop
  ignore-abort: true
  ignore-state: true
  start-when:
  - script: test
    states: [aborted, passed, failed, skipped]
