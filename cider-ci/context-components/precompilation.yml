# Delivery Tests

task_defaults:
  traits: { g2016: yes } # only compile on fastest machines

contexts:
  'Assets':
    include: cider-ci/context-components/rails-setup.yml
    tasks:
      assets_manifest:
        name: 'Assets are precompiled and checked in'
        traits: { npm: yes }
        scripts:
          test:
            timeout: 10 Minutes
            body: |
              set -exu
              export PATH=~/.rubies/$RUBY/bin:$PATH
              mv public/assets tmp/static_assets
              bin/precompile-assets
              cider-ci/bin/check-precompiled-assets tmp/static_assets public/assets

  'npm':
    tasks:
      node-modules:
        name: "npm: node_modules are checked in"
        git_options: { submodules: { include_match: ^node_modules$ } }
        scripts:
          test:
            body:
              cider-ci/bin/check-node-modules

  'Docs/Specs':
    include: cider-ci/context-components/rails-setup.yml
    tasks:
      spec-docs:
        name: 'Docs: Render Overview from rspec feature specs'
        traits: { Ruby: on, nodejs: on }
        git_options: { submodules: { include_match: '.' } }
        tree_attachments:
          feature-specs:
            content_type: text/html
            include_match: "^tmp/feature.*.(html|json)$"
        scripts:
          test:
            body: |
              #!/usr/bin/env bash
              set -eux
              export PATH=~/.rubies/$RUBY/bin:$PATH
              node_modules/.bin/rspec-to-docs spec/features > ./tmp/features.html
              # sanity check as long as the cli does not correctly exit:
              grep -q "$CIDER_CI_TREE_ID" tmp/features.html
